<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Öğretmen-Öğrenci Ders Sistemi (PDF Büyük Görünür)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; background: #000; margin: 0; height: 100vh; }
        .video-mirror { transform: scaleX(-1); }
        
        /* Tam ekran paylaşım alanı - her iki tarafta da büyük olacak */
        #screenShareStage {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw; height: 100vh;
            background: #000;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        #screenVideo {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Sol alt köşede küçük kamera(lar) - her iki tarafta da görünecek */
        #miniCameras {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 12px;
            display: none;
        }
        .mini-video {
            width: 200px;
            height: 130px;
            border-radius: 16px;
            overflow: hidden;
            border: 4px solid #60a5fa;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .mini-label {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: bold;
        }

        /* Paylaşımı bitir butonu - sadece paylaşan görür */
        #stopShareBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 200;
            padding: 16px 24px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 16px;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            display: none;
        }

        .hidden-ui { opacity: 0; pointer-events: none; transform: translateY(-50px); transition: all 0.6s; }
    </style>
</head>
<body class="text-white">

    <!-- Tam Ekran PDF/Paylaşım Alanı (Her iki tarafta büyük görünür) -->
    <div id="screenShareStage" class="flex">
        <video id="screenVideo" autoplay playsinline></video>
        <div class="absolute top-10 left-10 bg-black bg-opacity-80 px-6 py-3 rounded-full text-lg font-bold animate-pulse">
            Ders Anlatımı Aktif
        </div>
    </div>

    <!-- Sol altta küçük kameralar (her iki tarafta da görünür) -->
    <div id="miniCameras">
        <div class="mini-video relative">
            <video id="miniLocal" autoplay muted playsinline class="w-full h-full object-cover video-mirror"></video>
            <div class="mini-label">Sen</div>
        </div>
        <div class="mini-video relative">
            <video id="miniRemote" autoplay playsinline class="w-full h-full object-cover"></video>
            <div class="mini-label">Karşı Taraf</div>
        </div>
    </div>

    <!-- Sadece paylaşımı başlatan kişi görür -->
    <button id="stopShareBtn" onclick="stopScreenShare()">Paylaşımı Bitir</button>

    <!-- Normal başlangıç ekranı -->
    <div id="controlPanel" class="absolute top-0 left-0 right-0 z-50 bg-gray-900 bg-opacity-95 p-6 backdrop-blur-md">
        <div class="max-w-5xl mx-auto flex flex-col md:flex-row items-center justify-between gap-6">
            <div>
                <div class="text-sm text-gray-400">Senin ID'n</div>
                <div class="font-mono text-2xl text-green-400 select-all" id="myId">...</div>
            </div>
            <div class="flex flex-col sm:flex-row gap-4 items-center">
                <input type="text" id="remoteIdInput" placeholder="Öğrenci ID" class="p-4 rounded-lg bg-gray-800 border border-gray-700 text-white w-64">
                <input type="password" id="passwordInput" placeholder="Şifre" class="p-4 rounded-lg bg-gray-800 border border-gray-700 text-white w-32">
                <button onclick="connectToPeer()" class="px-8 py-4 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold">Öğrenciyi Ara</button>
                <button onclick="toggleScreenShare()" id="shareBtn" class="px-8 py-4 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold">
                    <span id="shareBtnText">Dersi Başlat</span>
                </button>
                <button onclick="endCall()" class="px-8 py-4 bg-red-600 hover:bg-red-700 rounded-lg font-bold">Bitir</button>
            </div>
        </div>
    </div>

    <div id="status" class="absolute top-32 left-1/2 transform -translate-x-1/2 text-xl font-bold text-gray-300 z-50">Hazır</div>

    <!-- Normal kamera görünümü (bağlantı kurulmadan önce -->
    <div id="cameraContainer" class="flex flex-wrap justify-center items-center gap-10 min-h-screen p-10">
        <div class="relative bg-black rounded-2xl overflow-hidden shadow-2xl border-4 border-gray-700 w-96 h-72">
            <video id="localVideo" autoplay muted playsinline class="w-full h-full object-cover video-mirror"></video>
            <div class="absolute bottom-3 left-3 bg-black bg-opacity-70 px-4 py-2 rounded-lg text-sm">Sen (Öğretmen)</div>
        </div>
        <div class="relative bg-black rounded-2xl overflow-hidden shadow-2xl border-4 border-gray-700 w-96 h-72">
            <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video>
            <div class="absolute bottom-3 left-3 bg-black bg-opacity-70 px-4 py-2 rounded-lg text-sm">Öğrenci</div>
        </div>
    </div>

    <script>
        const EXPECTED_PASSWORD = "123";
        let peer = null, localStream = null, currentCall = null, screenStream = null;
        let isSharingScreen = false;

        const els = {
            myId: document.getElementById('myId'),
            localVideo: document.getElementById('localVideo'),
            remoteVideo: document.getElementById('remoteVideo'),
            miniLocal: document.getElementById('miniLocal'),
            miniRemote: document.getElementById('miniRemote'),
            screenVideo: document.getElementById('screenVideo'),
            screenStage: document.getElementById('screenShareStage'),
            miniCameras: document.getElementById('miniCameras'),
            controlPanel: document.getElementById('controlPanel'),
            cameraContainer: document.getElementById('cameraContainer'),
            status: document.getElementById('status'),
            shareBtnText: document.getElementById('shareBtnText'),
            stopShareBtn: document.getElementById('stopShareBtn')
        };

        // Kamera başlat
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                els.localVideo.srcObject = stream;
                els.miniLocal.srcObject = stream;
                initPeer();
            }).catch(err => alert("Kamera erişimi reddedildi: " + err.message));

        function initPeer() {
            peer = new Peer();
            peer.on('open', id => {
                els.myId.textContent = id;
                els.status.textContent = "Hazır - ID: " + id;
            });

            peer.on('call', call => {
                if (confirm("Gelen çağrı! Kabul edilsin mi?") && document.getElementById('passwordInput').value === EXPECTED_PASSWORD) {
                    call.answer(localStream);
                    handleCall(call);
                } else {
                    call.close();
                }
            });
        }

        function connectToPeer() {
            const id = document.getElementById('remoteIdInput').value.trim();
            const pass = document.getElementById('passwordInput').value;
            if (!id || pass !== EXPECTED_PASSWORD) return alert("ID veya şifre yanlış!");
            const call = peer.call(id, localStream, { metadata: { password: pass } });
            handleCall(call);
        }

        function handleCall(call) {
            currentCall = call;

            call.on('stream', remoteStream => {
                // Gelen stream ekran paylaşımı mı?
                const isScreenShare = remoteStream.getVideoTracks()[0]?.getSettings()?.displaySurface === 'monitor' ||
                                       remoteStream.getVideoTracks()[0]?.label.toLowerCase().includes('screen');

                if (isScreenShare) {
                    // Karşı taraf ekran paylaşıyor → tam ekran göster
                    startScreenReceiveScreen(remoteStream);
                } else {
                    // Normal kamera
                    els.remoteVideo.srcObject = remoteStream;
                    els.miniRemote.srcObject = remoteStream;
                    if (isSharingScreen) return; // kendi ekran paylaşımımız devam ediyorsa dokunma
                    exitScreenMode(); // normal moda geç
                }
            });

            call.on('close', () => endCall());
        }

        // EKRAN PAYLAŞIMI ALINDIĞINDA (öğrenci tarafı veya öğretmen kendi paylaştığında)
        function startScreenReceive(screenStream) {
            els.screenStage.style.display = 'flex';
            els.screenVideo.srcObject = screenStream;
            els.miniCameras.style.display = 'flex';
            els.controlPanel.classList.add('hidden-ui');
            els.cameraContainer.classList.add('hidden-ui');
            els.status.classList.add('hidden-ui');
            els.stopShareBtn.style.display = 'none'; // sadece paylaşan görür
        }

        function exitScreenMode() {
            els.screenStage.style.display = 'none';
            els.miniCameras.style.display = 'none';
            els.controlPanel.classList.remove('hidden-ui');
            els.cameraContainer.classList.remove('hidden-ui');
            els.status.classList.remove('hidden-ui');
        }

        // EKRAN PAYLAŞIMI BAŞLAT (sadece öğretmen yapar)
        async function toggleScreenShare() {
            if (isSharingScreen) {
                stopScreenShare();
                return;
            }

            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "always" }, audio: true });
                startScreenReceive(screenStream); // kendi tarafında da tam ekran göster
                els.shareBtnText.textContent = "Dersi Bitir";
                els.stopShareBtn.style.display = 'block';
                isSharingScreen = true;

                // Mevcut çağrıdaki video track'i değiştir
                const sender = currentCall.peerConnection.getSenders().find(s => s.track?.kind === 'video');
                if (sender) sender.replaceTrack(screenStream.getVideoTracks()[0]);

                screenStream.getVideoTracks()[0].onended = stopScreenShare;
            } catch (err) {
                console.log("Paylaşım iptal edildi");
            }
        }

        function stopScreenShare() {
            if (!isSharingScreen) return;

            screenStream?.getTracks().forEach(t => t.stop());
            screenStream = null;
            isSharingScreen = false;

            exitScreenMode();

            els.shareBtnText.textContent = "Dersi Başlat";
            els.stopShareBtn.style.display = 'none';

            // Normal kameraya dön
            const sender = currentCall?.peerConnection.getSenders().find(s => s.track?.kind === 'video');
            if (sender && localStream) sender.replaceTrack(localStream.getVideoTracks()[0]);
        }

        function endCall() {
            if (currentCall) currentCall.close();
            if (isSharingScreen) stopScreenShare();
            setTimeout(() => location.reload(), 1000);
        }
    </script>
</body>
</html>