<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ders Anlatma & Tam Ekran PDF Paylaşımı</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; background: #000; margin: 0; }
        .video-mirror { transform: scaleX(-1); }

        /* Sol alt köşede küçük kameralar */
        #miniCameras {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: all 0.4s ease;
        }
        .mini-video {
            width: 180px;
            height: 120px;
            border-radius: 16px;
            overflow: hidden;
            border: 4px solid #60a5fa;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .mini-label {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0,0,0,0.7);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
        }

        /* Tam ekran paylaşım alanı */
        #screenShareStage {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: #000;
            z-index: 10;
            align-items: center;
            justify-content: center;
        }
        #screenVideo {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Kontrol paneli (paylaşım sırasında gizlenecek) */
        #controlPanel, #status, #cameraContainer { transition: all 0.6s ease; }
        .hidden-ui { opacity: 0; pointer-events: none; transform: translateY(-50px); }

        /* Gelen çağrı */
        #incomingCallModal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #1f2937;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.9);
            z-index: 200;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body class="text-white">

    <!-- Tam Ekran Paylaşım Alanı -->
    <div id="screenShareStage" class="flex">
        <video id="screenVideo" autoplay playsinline></video>
        <div class="absolute top-10 left-10 bg-black bg-opacity-80 px-6 py-3 rounded-full text-lg font-bold animate-pulse">
            Ders Anlatımı Aktif
        </div>
    </div>

    <!-- Sol Altta Küçük Kameralar -->
    <div id="miniCameras" style="display:none;">
        <div class="mini-video relative">
            <video id="miniLocal" autoplay muted playsinline class="w-full h-full object-cover video-mirror"></video>
            <div class="mini-label">Sen</div>
        </div>
        <div class="mini-video relative">
            <video id="miniRemote" autoplay playsinline class="w-full h-full object-cover"></video>
            <div class="mini-label">Öğrenci</div>
        </div>

        <!-- Paylaşımı Durdur Butonu (sadece paylaşan görür) -->
        <button onclick="stopScreenShare()" id="stopShareBtn" class="mt-4 px-8 py-4 bg-red-600 hover:bg-red-700 rounded-xl font-bold text-lg shadow-2xl">
            Paylaşımı Bitir
        </button>
    </div>

    <!-- Gelen Çağrı -->
    <div id="incomingCallModal">
        <p class="text-2xl mb-6 font-bold">Gelen Ders Çağrısı!</p>
        <div class="flex gap-6 justify-center">
            <button onclick="answerCall()" class="px-10 py-4 bg-green-600 hover:bg-green-700 rounded-lg font-bold text-lg">Kabul Et</button>
            <button onclick="rejectCall()" class="px-10 py-4 bg-red-600 hover:bg-red-700 rounded-lg font-bold text-lg">Reddet</button>
        </div>
    </div>

    <!-- Kontrol Paneli (normalde görünür, paylaşımda kaybolur) -->
    <div id="controlPanel" class="absolute top-0 left-0 right-0 z-50 bg-gray-900 bg-opacity-95 p-6 backdrop-blur-md">
        <div class="max-w-5xl mx-auto flex flex-col md:flex-row items-center justify-between gap-6">
            <div class="text-center md:text-left">
                <div class="text-sm text-gray-400">Senin ID'n</div>
                <div class="font-mono text-2xl text-green-400 select-all" id="myId">...</div>
            </div>
            <div class="flex flex-col sm:flex-row gap-4 items-center">
                <input type="text" id="remoteIdInput" placeholder="Öğrenci ID" class="p-4 rounded-lg bg-gray-800 border border-gray-700 text-white w-full sm:w-64">
                <input type="password" id="passwordInput" placeholder="Şifre" class="p-4 rounded-lg bg-gray-800 border border-gray-700 text-white w-32">
                <button onclick="connectToPeer()" class="px-8 py-4 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold">Öğrenciyi Ara</button>
                <button onclick="toggleScreenShare()" id="shareBtn" class="px-8 py-4 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold">
                    <span id="shareBtnText">Dersi Başlat</span>
                </button>
                <button onclick="endCall()" class="px-8 py-4 bg-red-600 hover:bg-red-700 rounded-lg font-bold">Bitir</button>
            </div>
        </div>
    </div>

    <div id="status" class="absolute top-32 left-1/2 transform -translate-x-1/2 text-xl font-bold text-gray-300 z-50">Hazır</div>

    <!-- Normal kamera görünümü -->
    <div id="cameraContainer" class="flex flex-wrap justify-center items-center gap-10 min-h-screen p-10">
        <div class="relative bg-black rounded-2xl overflow-hidden shadow-2xl border-4 border-gray-700 w-96 h-72">
            <video id="localVideo" autoplay muted playsinline class="w-full h-full object-cover video-mirror"></video>
            <div class="absolute bottom-3 left-3 bg-black bg-opacity-70 px-4 py-2 rounded-lg text-sm font-bold">Sen (Öğretmen)</div>
        </div>
        <div class="relative bg-black rounded-2xl overflow-hidden shadow-2xl border-4 border-gray-700 w-96 h-72">
            <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video>
            <div class="absolute bottom-3 left-3 bg-black bg-opacity-70 px-4 py-2 rounded-lg text-sm font-bold">Öğrenci</div>
        </div>
    </div>

    <script>
        const EXPECTED_PASSWORD = "123";
        let peer = null, localStream = null, currentCall = null, screenStream = null;
        let isSharing = false, isReceivingScreen = false;

        const elements = {
            myId: document.getElementById('myId'),
            status: document.getElementById('status'),
            localVideo: document.getElementById('localVideo'),
            remoteVideo: document.getElementById('remoteVideo'),
            miniLocal: document.getElementById('miniLocal'),
            miniRemote: document.getElementById('miniRemote'),
            screenStage: document.getElementById('screenShareStage'),
            screenVideo: document.getElementById('screenVideo'),
            cameraContainer: document.getElementById('cameraContainer'),
            controlPanel: document.getElementById('controlPanel'),
            miniCameras: document.getElementById('miniCameras'),
            shareBtnText: document.getElementById('shareBtnText'),
            incomingModal: document.getElementById('incomingCallModal'),
            stopShareBtn: document.getElementById('stopShareBtn')
        };

        // Kamera başlat
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                elements.localVideo.srcObject = stream;
                elements.miniLocal.srcObject = stream;
                initPeer();
            });

        function initPeer() {
            peer = new Peer();
            peer.on('open', id => {
                elements.myId.textContent = id;
                elements.status.textContent = "Hazır - ID: " + id;
            });

            peer.on('call', call => {
                incomingCall = call;
                elements.incomingModal.style.display = 'block';
            });
        }

        function answerCall() {
            if (incomingCall.metadata?.password !== EXPECTED_PASSWORD) return alert("Şifre yanlış!");
            elements.incomingModal.style.display = 'none';
            incomingCall.answer(localStream);
            handleCall(incomingCall);
        }

        function rejectCall() {
            if (incomingCall) incomingCall.close();
            elements.incomingModal.style.display = 'none';
        }

        function connectToPeer() {
            const id = document.getElementById('remoteIdInput').value.trim();
            const pass = document.getElementById('passwordInput').value;
            if (!id || pass !== EXPECTED_PASSWORD) return alert("ID veya şifre hatalı!");
            const call = peer.call(id, localStream, { metadata: { password: pass } });
            handleCall(call);
        }

        function handleCall(call) {
            currentCall = call;
            call.on('stream', stream => {
                const isScreen = stream.getVideoTracks()[0]?.label.toLowerCase().includes('screen') ||
                                stream.getVideoTracks()[0]?.getSettings()?.displaySurface;

                if (isScreen) {
                    enterLessonMode(stream);
                } else if (isReceivingScreen) {
                    exitLessonMode(stream);
                } else {
                    elements.remoteVideo.srcObject = stream;
                    elements.miniRemote.srcObject = stream;
                }
            });
        }

        // DERS MODU: Tam ekran PDF + sol altta küçük kameralar
        function enterLessonMode(screenStream) {
            isReceivingScreen = true;
            elements.screenStage.style.display = 'flex';
            elements.screenVideo.srcObject = screenStream;
            elements.miniCameras.style.display = 'flex';
            elements.cameraContainer.classList.add('hidden-ui');
            elements.controlPanel.classList.add('hidden-ui');
            elements.status.classList.add('hidden-ui');
            elements.stopShareBtn.style.display = 'none'; // sadece paylaşan görür
        }

        function exitLessonMode(cameraStream) {
            isReceivingScreen = false;
            elements.screenStage.style.display = 'none';
            elements.miniCameras.style.display = 'none';
            elements.cameraContainer.classList.remove('hidden-ui');
            elements.controlPanel.classList.remove('hidden-ui');
            elements.status.classList.remove('hidden-ui');
            elements.remoteVideo.srcObject = cameraStream;
            elements.miniRemote.srcObject = cameraStream;
        }

        async function toggleScreenShare() {
            if (!isSharing) {
                screenStream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "always" }, audio: true });
                enterLessonMode(screenStream);
                elements.shareBtnText.textContent = "Dersi Bitir";
                elements.stopShareBtn.style.display = 'block';
                isSharing = true;

                const sender = currentCall.peerConnection.getSenders().find(s => s.track?.kind === 'video');
                if (sender) sender.replaceTrack(screenStream.getVideoTracks()[0]);

                screenStream.getVideoTracks()[0].onended = stopScreenShare;
            }
        }

        function stopScreenShare() {
            if (!isSharing) return;
            screenStream.getTracks().forEach(t => t.stop());
            screenStream = null;
            exitLessonMode(localStream);
            elements.shareBtnText.textContent = "Dersi Başlat";
            elements.stopShareBtn.style.display = 'none';
            isSharing = false;

            const sender = currentCall.peerConnection.getSenders().find(s => s.track?.kind === 'video');
            if (sender && localStream) sender.replaceTrack(localStream.getVideoTracks()[0]);
        }

        function endCall() {
            if (currentCall) currentCall.close();
            if (isSharing) stopScreenShare();
            location.reload(); // En temiz yol
        }
    </script>
</body>
</html>